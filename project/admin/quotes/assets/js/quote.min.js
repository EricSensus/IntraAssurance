$(function(){function e(){$("div.customer_entities").empty(),$.each(o,function(e,t){$("div.customer_entities").append(t.content)})}function t(){var e=!0;return $("#quoteform").data("Zebra_Form").validate()&&($("input.required").each(function(){0==$.trim($(this).val()).length||"0.00"==$.trim($(this).val())?($(this).addClass("redline"),e=!1):$(this).removeClass("redline")}),$("select.required").each(function(){0==$.trim($(this).val()).length?($(this).addClass("redline"),e=!1):$(this).removeClass("redline")})),e}function i(e){switch(e){case"1":s=["Cover_Type","Cover_Start","Cover_End"];break;default:s=[]}}function a(){var e=[];return $.each(s,function(t,i){""==$("[name="+i+"]").val()&&e.push(i)}),o.length<1&&e.push("Entity"),$("option.addnew").is(":selected")&&e.pop("Entity"),$(".required").each(function(t,i){""==$(this).val()&&e.push($(this).attr("name"))}),e.filter(function(e){return e})}function n(){d.addClass("disabled").attr("disabled",!0),$("#quote-preview").html(PRELOADER1);var e=$("#quoteform"),i=a();if(i.length>0)return t(),void $("#quote-preview").html("Cannot preview at the moment<br>Please fill the following fields : "+i);$.ajax({url:SITE_PATH+"/admin/preview/quote",method:"post",data:e.serialize(),success:function(e){$("#quote-preview").html(e),d.removeClass("disabled").attr("disabled",!1)},error:function(e){$("#quote-preview").html("This quote could not be previewed<br/>"+e)}})}if($("head").append('<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.structure.min.css">'),$("head").append('<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">'),$("body").on("focus",".mydatepicker",function(){var e=$(this).attr("dervis-date");void 0===e&&(e="yy-mm-dd"),$(this).datepicker({dateFormat:e})}),"undefined"!=typeof SITE_PATH){var r=null,o=[],s=[],l=$("button.addentity"),d=$('input[name="btnsubmit"]'),u=$("select[name=product]"),c=$("input[name=customer]"),m=$("div.customer_product_information");d.addClass("disabled").attr("disabled",!0),l.hide(),u.val(""),c.devbridgeAutocomplete({serviceUrl:SITE_PATH+"/ajax/admin/quotes/getcustomer",minChars:1,onSearchStart:function(e){var t=$(this).val();$(".autocomplete-suggestions").html("Searching: "+t)},onSelect:function(e){$(this).val(e.value);$("input[name=customerid]").val(e.data),$.get(SITE_PATH+"/ajax/admin/quotes/getcustomerdetails",{id:e.data},function(e){var t=$.parseJSON(e);$.each(t,function(e,t){$("#"+e).val(t)})})}}),u.on("change",function(){r=$(this).val();var t=$("input[name=customerid]").val();o=[],""!=r?($.ajax({url:SITE_PATH+"/ajax/admin/products/getfullproductform/",method:"post",data:{id:r},beforeSend:function(){m.html(PRELOADER1)},success:function(e){m.empty(),$("tr.extra_form_fields").remove(),$("table.product-details tr:last").after(e)},error:function(e){m.html(e)}}),$.ajax({url:SITE_PATH+"/ajax/admin/entities/selectformfromproductid/",method:"post",data:{ajax:"yes",productid:r,customerid:t},beforeSend:function(){$("div.customer_entity_select").html(PRELOADER2)},success:function(e){$("#interimSave").parents("tr").remove(),$("div.customer_entity_select").html(e);var t=$("select[name=entities]").val();t!=$("input[name=newentity]").val()&&""!=t&&l.show()}}),i(r)):($("tr.extra_form_fields").remove(),$("table.product-details tr:last").after(""),$("div.customer_entity_select").html(""),m.html("")),e(),n()}),$("div.customer_entity_select").on("change","select",function(){$("#interimSave").parents("tr").remove();var e=$("select[name=entities]").val(),t=$("input[name=entityformid_"+e+"]").val(),i=$("input[name=newentity]").val();e==i?(l.hide(),$("table.entity-details tr.extra_form_fields").remove(),$("div.customer_entities").html(PRELOADER1),$.ajax({url:SITE_PATH+"/ajax/admin/entities/getfullentityform",method:"post",data:{defaultval:t},success:function(e){$("div.customer_entities").empty(),$("table.entity-details tr:last").after(e),$("table.entity-details tr:last").after("<tr><td></td><td><button id='interimSave'>Save Entity</button></td></tr>")}})):(e!=i&&""!=e&&l.show(),$("table.entity-details tr.extra_form_fields").remove())}),l.on("click",function(){var t=$("select[name=entities]").val();if(o.filter(function(e){return e.id===t}).length>0)return void console.log("Already in view");$("div.customer_entities").html(PRELOADER1),$.ajax({url:SITE_PATH+"/ajax/admin/entities/returnentityentries",method:"post",data:{ajax:"yes",entityval:t},success:function(i){o.push({id:t,content:i}),e(),n(),$('select[name=entities] option[value="'+t+'"]').remove()}})}),$("div.customer_entities").on("click","a",function(){if(confirm("This will delete this entity. Proceed?")){var e=$(this).attr("id");$("."+e).remove(),o=o.filter(function(t){return t.id!==e}),n()}}),d.on("click",function(e){e.preventDefault(),t()?$("#quoteform").submit():$("html, body").animate({scrollTop:$(".redline").first().offset().top},1e3)}),$("#previewer").click(function(e){e.preventDefault(),n()}),$("body").on("click","#interimSave",function(e){e.preventDefault();var i=$("#quoteform");if(a().length>0)return void t();$.ajax({url:SITE_PATH+"/admin/preview/saveentity",method:"post",data:i.serialize(),success:function(e){var t=$.parseJSON(e);$("select[name=entities]").append($("<option>",{value:t.id,text:t.name})),$("select[name=entities]").val(t.id).change(),$("#interimSave").parents("tr").remove(),l.show(),l.click()},error:function(e){console.log(e)}})}),$("body").on("focus",".date_start",function(){$(this).datepicker("option","onSelect",function(e){var t=$("input.date_end");t.datepicker("destroy"),t.removeClass("hasDatepicker").removeClass("mydatepicker").removeAttr("id"),t.attr("readonly",!0);var i=$(this).datepicker("getDate");if(""!=i){var a=new Date(i);a.setFullYear(a.getFullYear()+1),$("input.date_end").val(a.toISOString().slice(0,10))}})})}});