$(function(){function e(){var e=!0;return $("#quoteform").data("Zebra_Form").validate()&&($("input.required").each(function(){0==$.trim($(this).val()).length||"0.00"==$.trim($(this).val())?($(this).addClass("redline"),e=!1):$(this).removeClass("redline")}),$("select.required").each(function(){0==$.trim($(this).val()).length?($(this).addClass("redline"),e=!1):$(this).removeClass("redline")})),e}function t(e){switch(e){case"1":d=["Cover_Type","Cover_Start","Cover_End"];break;default:d=[]}}function n(){var e=[];return $.each(d,function(t,n){""==$(document).find("[name="+n+"]").val()&&e.push(n)}),a.length<1&&e.push("Entity"),$("option.addnew").is(":selected")&&e.pop("Entity"),$(".required").each(function(t,n){""==$(this).val()&&e.push($(this).attr("name"))}),e.filter(function(e){return e})}function i(){$(document).find('input[name="btnsubmit"]').addClass("disabled").attr("disabled",!0),$(document).find("#quote-preview").html(PRELOADER1);var t=$(document).find("#quoteform"),i=n();if(i.length>0)return e(),void $(document).find("#quote-preview").html("Cannot preview at the moment<br>Please fill the following fields : "+i);$.ajax({url:SITE_PATH+"/admin/preview/quote",method:"post",data:t.serialize(),success:function(e){$(document).find("#quote-preview").html(e),$(document).find('input[name="btnsubmit"]').removeClass("disabled").attr("disabled",!1)},error:function(e){$(document).find("#quote-preview").html("This quote could not be previewed<br/>"+e)}})}if($("head").append('<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.structure.min.css">'),$("head").append('<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">'),$("body").on("focus",".mydatepicker",function(){var e=$(this).attr("dervis-date");void 0===e&&(e="yy-mm-dd"),$(this).datepicker({dateFormat:e})}),"undefined"!=typeof SITE_PATH){var a=[],d=[];$('input[name="btnsubmit"]').addClass("disabled").attr("disabled",!0),$("button.addentity").hide(),$("select[name=product]").val(""),$(document).on("change","select[name=product]",function(){var e=$(this).val(),n=$("input[name=customerid]").val();""!=e&&($("div.ajaxresponse1").html(PRELOADER1),$("div.ajaxresponse2").html(PRELOADER2),$.ajax({url:SITE_PATH+"/ajax/admin/products/getfullproductform/",method:"post",data:{id:e},success:function(e){$("div.ajaxresponse1").empty(),$("tr.extra_form_fields").remove(),$("table.product-details tr:last").after(e)},error:function(e){$("div.ajaxresponse1").html(e)}}),$.ajax({url:SITE_PATH+"/ajax/admin/entities/selectformfromproductid/",method:"post",data:{ajax:"yes",productid:e,customerid:n},success:function(e){$("div.ajaxresponse2").html(e);var t=$("select[name=entities]").val();t!=$("input[name=newentity]").val()&&""!=t&&$("button.addentity").show()}}),t(e))}),$(document).on("change","div.ajaxresponse2","select",function(){var e=$("select[name=entities]").val(),t=$("input[name=entityformid_"+e+"]").val(),n=$("input[name=newentity]").val();$("select[name=insurers]").removeAttr("disabled"),e==n?($("button.addentity").hide(),$("table.entity-details tr.extra_form_fields").remove(),$("div.ajaxresponse3").html(PRELOADER1),$.ajax({url:SITE_PATH+"/ajax/admin/entities/getfullentityform",method:"post",data:{defaultval:t},success:function(e){$("#interimSave").parents("tr").remove(),$("div.ajaxresponse3").empty(),$("table.entity-details tr:last").after(e),$("table.entity-details tr:last").after("<tr><td></td><td><button id='interimSave'>Save Entity</button></td></tr>")}})):(e!=n&&""!=e&&$("button.addentity").show(),$("table.entity-details tr.extra_form_fields").remove())}),$(document).on("click","button.addentity",function(){var e=$(document).find("div.ajaxresponse3").html(),t=$(document).find("select[name=entities]").val();a.indexOf(t)>=0||($(document).find("div.ajaxresponse3").html(PRELOADER1),$.ajax({url:SITE_PATH+"/ajax/admin/entities/returnentityentries",method:"post",data:{ajax:"yes",entityval:t},success:function(n){$(document).find('#insurers option[value="'+t+'"]').remove(),$(document).find("div.ajaxresponse3").empty(),$(document).find("div.ajaxresponse3").html(e+n),a.push(t),i()}}))}),$("body .delete_stored_entity").on("click","a",function(){if(confirm("This will delete this entity. Proceed?")){var e=$(this).attr("id");$("."+e).remove(),a.pop(e),i()}}),$("#quoteform").on("submit",function(t){t.preventDefault(),e()?$("#quoteform").submit():$("html, body").animate({scrollTop:$(".redline").first().offset().top},1e3)}),$(document).on("click","#previewer",function(){i()}),$("body").on("click","#interimSave",function(t){t.preventDefault();var i=$(document).find("#quoteform");return n().length>0?void e():$(document).find("option.addnew").is(":selected")?void $.ajax({url:SITE_PATH+"/admin/preview/saveentity",method:"post",data:i.serialize(),success:function(e){var t=$.parseJSON(e);$("select[name=entities]").append($("<option>",{value:t.id,text:t.name})),$(document).find("select[name=entities]").val(t.id).change(),$(document).find("#interimSave").parents("tr").remove(),$(document).find("button.addentity").show(),$(document).find("button.addentity").click()},error:function(e){alert(e)}}):void alert("Cannot add now")}),$("body").on("focus",".date_start",function(){$(this).datepicker("option","onSelect",function(e){var t=$("input.date_end");t.datepicker("destroy"),t.removeClass("hasDatepicker").removeClass("mydatepicker").removeAttr("id"),t.attr("readonly",!0);var n=$(this).datepicker("getDate");if(""!=n){var i=new Date(n);console.log(i),i.setFullYear(i.getFullYear()+1),$("input.date_end").val(i.toISOString().slice(0,10))}})})}});